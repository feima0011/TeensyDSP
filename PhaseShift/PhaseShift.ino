#include <Audio.h>
#include <Wire.h>
#include <SPI.h>
#include <SD.h>
#include <SerialFlash.h>

#include <si5351.h>

Si5351 si5351;

AudioControlSGTL5000 ctl;
AudioAmplifier amp;

AudioInputI2S            i2s1;           //xy=233,194
AudioFilterFIR           fir2;           //xy=494,294
AudioFilterFIR           fir1;           //xy=498,93
AudioOutputI2S           i2s2;           //xy=743,192
AudioConnection          patchCord1(i2s1, 0, fir1, 0);
AudioConnection          patchCord2(i2s1, 1, fir2, 0);
AudioConnection          patchCord3(fir2, 0, i2s2, 1);
AudioConnection          patchCord4(fir1, 0, i2s2, 0);

#define NUM_COEFFS 60

double minus45Coeffs[] =
{
-0.000540573800649125,
-0.001233598171358445,
-0.001911431221479251,
-0.002182205783534563,
-0.001855837509380513,
-0.001308569234292864,
-0.001440938991744093,
-0.003075251746647638,
-0.006118882220800267,
-0.009184355258518899,
-0.010220749539045278,
-0.008016884405968188,
-0.003609990889256435,
-0.000353457882529157,
-0.002084713757492308,
-0.010218969234006026,
-0.021747325379347465,
-0.030036002568731766,
-0.028720442446635207,
-0.016697472410903858,
-0.000810676651078797,
 0.006429852533691062,
-0.006103540278034318,
-0.039913005142028807,
-0.082646977334586924,
-0.111541574262098292,
-0.103955122393893151,
-0.049899702649892644,
 0.040454195343354531,
 0.139154005526590074,
 0.212290517657894001,
 0.235455608679584039,
 0.204772993494815425,
 0.137769692834391361,
 0.063928781395772877,
 0.010306073732483425,
-0.010096379887707931,
-0.001602735039723860,
 0.019800254672920153,
 0.036813575704638703,
 0.039705112217279986,
 0.029329431223086278,
 0.013857150154882708,
 0.002334338713605908,
-0.000656839061629316,
 0.003516685903656492,
 0.009845219536082058,
 0.013516603537862052,
 0.012652233947933541,
 0.008589844457287251,
 0.004176190642464812,
 0.001631140048432858,
 0.001406134773012413,
 0.002463099867285694,
 0.003388672477472021,
 0.003389699679249209,
 0.002567156444615758,
 0.001517117816900269,
 0.000741756061372653,
 0.000331421641481621 
};

double plus45Coeffs[] =
{
0.000331421641481599,
 0.000741756061372546,
 0.001517117816900081,
 0.002567156444615612,
 0.003389699679249304,
 0.003388672477472464,
 0.002463099867286321,
 0.001406134773012781,
 0.001631140048432497,
 0.004176190642463624,
 0.008589844457285766,
 0.012652233947932743,
 0.013516603537862751,
 0.009845219536084141,
 0.003516685903658678,
-0.000656839061628899,
 0.002334338713603353,
 0.013857150154877814,
 0.029329431223081678,
 0.039705112217278980,
 0.036813575704642998,
 0.019800254672928067,
-0.001602735039717531,
-0.010096379887709561,
 0.010306073732469929,
 0.063928781395749146,
 0.137769692834364993,
 0.204772993494797245,
 0.235455608679582873,
 0.212290517657912459,
 0.139154005526622715,
 0.040454195343390287,
-0.049899702649865527,
-0.103955122393881869,
-0.111541574262102705,
-0.082646977334600802,
-0.039913005142043399,
-0.006103540278042981,
 0.006429852533690352,
-0.000810676651074026,
-0.016697472410898171,
-0.028720442446632320,
-0.030036002568732793,
-0.021747325379350962,
-0.010218969234009513,
-0.002084713757493936,
-0.000353457882528627,
-0.003609990889254757,
-0.008016884405966745,
-0.010220749539044912,
-0.009184355258519575,
-0.006118882220801354,
-0.003075251746648455,
-0.001440938991744330,
-0.001308569234292643,
-0.001855837509380156,
-0.002182205783534330,
-0.001911431221479204,
-0.001233598171358499,
-0.000540573800649172
};

short int plus45[NUM_COEFFS];
short int minus45[NUM_COEFFS];

void transformCoeffs( short int out[], double in[], int k )
{
  for ( int i = 0 ; i < k ; i++ )
    out[i] = 32768 * in[i];
}

void setup() 
{

  Serial.begin(9600);

  bool i2c_found = si5351.init(SI5351_CRYSTAL_LOAD_8PF, 0, 0);
  si5351.drive_strength(SI5351_CLK0, SI5351_DRIVE_2MA);
  si5351.drive_strength(SI5351_CLK2, SI5351_DRIVE_2MA);


  transformCoeffs( plus45, plus45Coeffs, NUM_COEFFS );
  transformCoeffs( minus45, minus45Coeffs, NUM_COEFFS );


/*
  for ( int i = 0 ; i < NUM_COEFFS ; i++ )
    Serial.println( plus45[i] );
*/

    
  AudioMemory(160);
  ctl.enable();
  ctl.volume(0.8);
  ctl.inputSelect(AUDIO_INPUT_LINEIN);

  amp.gain( 10 );
  fir1.begin(plus45, NUM_COEFFS);
  fir2.begin(minus45, NUM_COEFFS);
    
}

void loop() 
{
}
